---
title: "chelsea_consult"
author: "Avery Richards"
date: '2022-04-18'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 This example looks at the distributive qualities of the `symptoms` and `barriers` responses on their own. Exploring the relationships could be tricky without exhaustive coding of variables. One approach leverages some advanced data wrangling methods, explained later. 
 
 At the end of the day, you'd need to quantify both variables in some respect, but do that in a way they could be compared through an equivalency of measurement. Some kind of scale, regularized measure, matrix, etc.
 
You could categorize both variables into a few groups, then maybe compare them with a chi-square test? Total of 4 to 6 groups in the data set. eg: high barrier / low barrier & 1 symptom / more than one symptom. Create categories and run analyses on those groups. 

Survey data structured in a way that creates many groups based on unique response combinations. 

```{r}

library(tidyverse)
library(cowplot)
library(naniar)
library(janitor)

# note: some conflicts with dplyr, 
# need to use :: to toggle package specific functions.
library(psych)
library(gplots)
library(arm)



```

```{r}

mn_df <- read.csv("anon_survey_data.csv") %>% 
  janitor::clean_names()

names(mn_df)
```


```{r}
naniar::vis_miss(mn_df)
```



```{r}

symptoms_df <- mn_df %>% dplyr::select(symptoms) %>% 
  # filter empty rows, if any. 
  filter(symptoms != "")


# 40 distinct symptom categories. 
symptoms_df %>% distinct(symptoms)

# Are these outputs of tick boxes? Could there be a data quality issue with linearity. It's only string data here after all. D, A == A, D, etc. Just a thought! 

```


```{r}

# make a new column, replacing verbose response category with concise string element. 
symptoms_truncated <- symptoms_df %>%  
  mutate(
symptoms_trunc = case_when(
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy)" ~ 
        "Anxiety / Depression",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy)" ~
        "Anxiety",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy),Eating disorder symptoms (e.g., binging, purging, restriction)" ~ 
        "Anxiety / Depression /  Eating Disorder",
      symptoms == "Depression symptoms (e.g., sadness, loss of energy, unhappy)" ~
        "Depression",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy),Post Traumatic Stress Disorder symptoms (e.g., trauma, anxiety, flashbacks)" ~ 
        "Anxiety / Trauma",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy),Eating disorder symptoms (e.g., binging, purging, restriction),Post Traumatic Stress Disorder symptoms (e.g., trauma, anxiety, flashbacks)" ~ 
        "Anxiety / Depression / Eating Disorder / Trauma",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy),Eating disorder symptoms (e.g., binging, purging, restriction),Substance use disorder symptoms (e.g., cravings, loss of control, substance dependency)" ~ 
        "Anxiety / Depression / Eating Disorder / Substance Use",
      symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Depression symptoms (e.g., sadness, loss of energy, unhappy),Substance use disorder symptoms (e.g., cravings, loss of control, substance dependency)" ~ 
        "Anxiety / Depression / Substance Use", 
       symptoms == "Anxiety symptoms (e.g., feeling nervous, tense, uneasy),Eating disorder symptoms (e.g., binging, purging, restriction)" ~ "Anxiety / Substance Use",
        TRUE ~ as.character(symptoms)
    ))


```

```{r}

# create summary object of symptoms response
count_symptoms <- symptoms_truncated %>% 
  dplyr::select(symptoms_trunc) %>% 
  group_by(symptoms_trunc) %>% 
  # count unique responses.
  summarise(n_response_type = n()) %>% 
  # make proportion of total responses. 
  mutate(sym_type_prop = round(n_response_type / 627, 2)) %>% 
  arrange(desc(sym_type_prop)) %>% 
  # filter up to most common responses. 
  filter(n_response_type > 9)


```



```{r}

# visualize
symptom_graph <- ggplot(data = count_symptoms, 
       aes(x = reorder(symptoms_trunc, sym_type_prop), 
           y = sym_type_prop)) +
  geom_col(fill="orange",color = "black", alpha = .8) +
  # change axis of column, to read categories.
  coord_flip() +
  # constraint graph to proportion, not too much white space. 
  ylim(0, .6) +
  ylab("Proportion") +
  xlab("Common Responses") +
  ggtitle("Symptoms Reported") +
  theme_minimal() +
  theme(axis.text = element_text(size = 7)) 

symptom_graph

```

Apply same approach to `barriers` variable. 

```{r}

# barriers to services
mn_barriers <- mn_df %>% dplyr::select(barriers) %>% 
  filter(barriers != "")


# 242 distinct barriers
mn_barriers %>% distinct(barriers)
  
count_barriers <- mn_barriers %>% group_by(barriers) %>% 
  summarise(n_response_type = n()) %>% 
  mutate(bar_type_prop = round(n_response_type / 242, 2)) %>% 
  arrange(desc(bar_type_prop)) %>% 
  filter(n_response_type > 9)


```

```{r}


# visualize
barrier_graph <- ggplot(data = count_barriers, 
       aes(x = reorder(barriers, bar_type_prop), 
           y = bar_type_prop)) +
  geom_bar(stat="identity", fill="orange", 
           color = "black", alpha = .8) +
  coord_flip() +
  ylim(0, .6) +
  ylab("Proportion") +
  xlab("Common Responses") +
  ggtitle("Service Barriers") +
  theme_minimal() +
  theme(axis.text = element_text(size = 5)) 

barrier_graph

```


```{r}


plot_grid(symptom_graph, barrier_graph, nrow = 2)

```

Using `group_by` and `summarise` to compare groups. This can get "in the weeds" a little bit, but can also shed insight around combinations of responses among participants.  

```{r}

symptom_barrier_counts <- mn_df %>% 
  dplyr::select(symptoms, barriers) %>% 
  filter(symptoms != "") %>% 
  group_by(symptoms, barriers) %>% 
  summarise(count = n()) %>% 
  mutate(prop = round(count / 405, 4)) %>% 
  arrange(desc(count))
  


```

```{r}

# create matrix from truncated symptom responses. 
# used summary object as example: the responses were truncated. 
symptom_variables <- count_symptoms %>% 
  dplyr::select(symptoms_trunc) %>% 
  # filter out no symptoms
  filter(symptoms_trunc != "Prefer not to say",
         symptoms_trunc != "No, none of these") %>% 
  # separate symptom categories 
  separate(symptoms_trunc, into = c("symptom_1", "symptom_2", 
                                    "symptom_3", "symptom_4"), 
           # the  / character separates them into new columns
           sep = '/') %>% 
  # pivoting: add a row id for each observation (person)
  rowid_to_column() %>% 
  # pivot long to associate each symptom with person. 
  pivot_longer(symptom_1:symptom_4, names_to = "symptom_cat", 
               values_to = "symptom_name", 
               values_drop_na = T) %>% 
  # clean up white space in symptom_name column.
  mutate(symptom_name = str_trim(symptom_name)) %>% 
  # select rowid and symptom name
  dplyr::select(rowid, symptom_name) %>% 
  # add a 1 to each row and pivot_wide.
  mutate(n =1) %>% 
  pivot_wider(names_from = symptom_name, 
              values_from = n, values_fill = list(n = 0)) %>% 
  janitor::clean_names()
  
# Could work with barriers as well.
# would only work if symptom strings were adjusted in the A / B / C structure. 

```
A data structure like this would let you really start counting stuff and could facilitate statistical functions. Especially when you begin to add other variables in your data set, like gender, race, age, etc. 

```{r}

# linear regression model with two variables. 
symptoms_mod <- lm(symptom_variables$eating_disorder ~ symptom_variables$anxiety, 
   data = symptom_variables)

# summary object of model. 
summary(symptoms_mod)




```

With this matrix structure, you could start asking questions like: "in our respondents, how much of eating disorder is explained by anxiety?" etc. 

Note: these kinds of tests provide statistical evidence, not necessarily truth! Best to put your psychology cap on and explore the variables in context before trying to draw any sort of conclusion from outputs like these..  


```{r}

# also these plots makes no sense while drawing from such a small n. 
plot(symptoms_mod)

```





